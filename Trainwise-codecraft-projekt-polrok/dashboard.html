<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainwise - Coach Dashboard</title>
    <link rel="stylesheet" href="style2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- CALENDAR STYLES --- */
        .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; }
        .calendar-day {
            background: #111; border: 1px solid #333; min-height: 100px; border-radius: 8px;
            padding: 8px; cursor: pointer; display: flex; flex-direction: column; gap: 3px; position: relative;
        }
        .calendar-day:hover { border-color: #FFD700; background: #161616; }
        .day-number { font-size: 0.9rem; color: #666; align-self: flex-end; }
        .event-pill {
            background: #222; border-left: 2px solid #FFD700; color: #fff;
            font-size: 0.8rem; padding: 4px; border-radius: 2px; margin-bottom: 2px;
            overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
        }
        .event-pill.self { border-left-color: #00FF88; opacity: 0.7; }

        
        .library-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .lib-card {
            background: #111; border: 1px solid #333; border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            transition: transform 0.2s, border-color 0.2s; position: relative;
        }
        .lib-card:hover { transform: translateY(-3px); border-color: #555; }
        .lib-icon {
            width: 40px; height: 40px; background: #222; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #FFD700; font-size: 1.2rem; margin-bottom: 10px;
        }
        .lib-title { font-weight: bold; color: white; font-size: 1rem; margin-bottom: 5px; }
        .lib-cat { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px; background: #000; padding: 3px 8px; border-radius: 4px; }
        .lib-del { position: absolute; top: 10px; right: 10px; color: #444; background: none; border: none; cursor: pointer; }
        .lib-del:hover { color: #FF4444; }

       
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #111; border: 1px solid #FFD700; width: 90%; max-width: 600px; padding: 20px; border-radius: 12px; max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;}
        
        .history-card { background: #111; border-radius: 12px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; position: relative; display: flex; justify-content: space-between; align-items: center; }
        .hist-actions button { background: none; border: none; color: #666; font-size: 1.1rem; cursor: pointer; margin-left: 10px; }
        .hist-actions button:hover { color: #FFD700; }
        .hist-actions button.del:hover { color: #FF4444; }

       
        .coach-select {
            background: #000; border: 1px solid #444; color: white; padding: 10px;
            border-radius: 6px; width: 100%; max-width: 300px; font-size: 1rem; margin-bottom: 20px;
        }
    </style>
</head>

<body>

    <header class="app-header">
        <a href="index.html" class="app-logo-container">
            <img src="images/logo3.png" alt="TR Logo" class="app-logo">
            <span class="app-title">COACH DASHBOARD</span>
        </a>

        <div class="header-right">
            <span id="header-username" class="user-name">Loading...</span>
            <a href="account.html" class="profile-link">
                <img id="header-profile-img" src="images/avatar-20.png" alt="Profile" class="header-avatar">
            </a>
        </div>
    </header>

    <div class="app-container">
        
        <aside class="app-sidebar">
            <a href="#" id="nav-dashboard" class="sidebar-btn active">
                <img src="images/dashboard.png" alt="Dashboard" class="sidebar-icon"> <span>Overview</span>
            </a>
            <a href="#" id="nav-clients" class="sidebar-btn">
                <img src="images/clients.png" alt="Clients" class="sidebar-icon"> <span>Clients</span>
            </a>
            <a href="#" id="nav-calendar" class="sidebar-btn">
                <img src="images/calendar.png" alt="Calendar" class="sidebar-icon"> <span>Calendar</span>
            </a>
            <a href="#" id="nav-messages" class="sidebar-btn">
                <img src="images/messages.png" alt="Messages" class="sidebar-icon"> <span>Messages</span>
            </a>
            <a href="#" id="nav-exercises" class="sidebar-btn">
                <img src="images/exercises.png" alt="Exercises" class="sidebar-icon"> <span>Exercises</span>
            </a>
            <a href="#" id="nav-workouts" class="sidebar-btn">
                <img src="images/workouts.png" alt="Workouts" class="sidebar-icon"> <span>Workouts</span>
            </a>
        </aside>

        <main class="app-content">
            
            <div id="section-overview">
                <div class="content-header">
                    <h2>Coach Overview</h2>
                    <p class="subtitle">Welcome back, Coach! Here is what's happening today.</p>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-label">Total Clients</span>
                        <span class="stat-value" id="stat-total-clients">-</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Active Programs</span>
                        <span class="stat-value">18</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Revenue (Dec)</span>
                        <span class="stat-value">1,450â‚¬</span>
                    </div>
                </div>
            </div>

            <div id="section-clients" style="display: none;">
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div><h2>My Clients</h2><p class="subtitle">Manage your athletes.</p></div>
                    <button id="add-client-btn" class="save-btn" style="width: auto; padding: 10px 25px;">+ Add Client</button>
                </div>
                <div class="dash-panel" style="min-height: 400px;">
                    <div id="clients-list-container">
                        <p style="color: #666; text-align: center; margin-top: 50px;">Loading clients...</p>
                    </div>
                </div>
            </div>

            <div id="section-calendar" style="display: none;">
                <div class="content-header">
                    <h2>Training Calendar</h2>
                    <p class="subtitle">Assign workouts to your athletes.</p>
                </div>
                <div class="dash-panel" style="border: 1px solid #333;">
                    <select id="cal-client-select" class="coach-select">
                        <option value="">Select Athlete to Plan...</option>
                    </select>

                    <div id="calendar-wrapper" style="display:none;">
                        <div class="calendar-controls">
                            <button onclick="prevMonth()" class="save-btn" style="width:auto; padding:5px 15px;"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="calendar-month-year" style="margin:0; color:white;">Month Year</h3>
                            <button onclick="nextMonth()" class="save-btn" style="width:auto; padding:5px 15px;"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div style="display:grid; grid-template-columns: repeat(7,1fr); text-align:center; color:#888; padding-bottom:10px;">
                            <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
                        </div>
                        <div id="calendar-grid" class="calendar-grid"></div>
                    </div>
                    <div id="cal-placeholder" style="text-align:center; padding:50px; color:#666;">
                        Please select an athlete above to view their calendar.
                    </div>
                </div>
            </div>

            <div id="section-messages" style="display: none;">
                <div class="content-header"><h2>Messages</h2></div>
                <div class="chat-layout">
                    <div class="chat-sidebar-list" id="chat-users-list"><p style="padding: 20px;">Loading...</p></div>
                    <div class="chat-window">
                        <div class="chat-header-bar">
                            <span id="chat-partner-name">Select an athlete</span>
                            <button id="delete-connection-btn" class="delete-connection-btn" style="display: none;">ðŸ—‘ Remove</button>
                        </div>
                        <div class="chat-messages-area" id="chat-messages-area"></div>
                        <form class="chat-input-area" id="chat-form" style="display: none;">
                            <input type="text" id="chat-input" class="chat-input" placeholder="Type a message..." autocomplete="off">
                            <button type="submit" class="chat-send-btn">âž¤</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="section-exercises" style="display: none;">
                <div class="content-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><h2>Exercise Library</h2><p class="subtitle">Manage your master library.</p></div>
                    <button onclick="openCreateExModal()" class="save-btn" style="width:auto; padding: 10px 20px;">+ NEW EXERCISE</button>
                </div>
                <div id="main-library-grid" class="library-grid">
                    <p style="text-align:center; color:#666; grid-column: 1/-1;">Loading library...</p>
                </div>
            </div>

            <div id="section-workouts" style="display: none;">
                <div class="content-header">
                    <h2>Client Workouts</h2>
                    <p class="subtitle">View and edit logged sessions.</p>
                </div>
                
                <select id="workout-client-select" class="coach-select">
                    <option value="">Select Athlete to view logs...</option>
                </select>

                <div id="client-workouts-list">
                    <p style="text-align:center; color:#666; padding:40px;">Select a client to load history.</p>
                </div>
            </div>

        </main>
    </div>

    <div id="invite-modal" class="modal-overlay">
        <div class="modal-box" style="width:400px;">
            <h3>Invite Athlete</h3>
            <span class="close-modal" onclick="document.getElementById('invite-modal').style.display='none'" style="float:right; cursor:pointer;">&times;</span>
            <input type="email" id="invite-email" placeholder="athlete@example.com" class="meta-input" style="margin:20px 0;">
            <button id="send-invite-btn" class="save-btn">Send Invitation</button>
            <p id="invite-status" style="margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="assign-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#FFD700;">Assign Workout</h3>
            <input type="hidden" id="assign-date">
            <input type="text" id="assign-title" class="meta-input" placeholder="Workout Title" style="margin-bottom:10px;">
            <textarea id="assign-note" class="meta-input" rows="3" placeholder="Instructions..."></textarea>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="saveAssignment()" class="save-btn">Assign</button>
                <button onclick="document.getElementById('assign-modal').style.display='none'" class="save-btn" style="background:#333;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="create-ex-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:white;">New Exercise</h3>
            <input type="text" id="new-ex-name" class="meta-input" placeholder="Name" style="margin-bottom:10px;">
            <select id="new-ex-cat" class="meta-input" style="margin-bottom:15px;">
                <option value="Chest">Chest</option><option value="Back">Back</option><option value="Legs">Legs</option>
                <option value="Shoulders">Shoulders</option><option value="Arms">Arms</option><option value="Abs">Abs</option><option value="Cardio">Cardio</option>
            </select>
            <div style="display:flex; gap:10px;">
                <button onclick="saveNewExercise()" class="save-btn">Create</button>
                <button onclick="document.getElementById('create-ex-modal').style.display='none'" class="save-btn" style="background:#333;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="edit-workout-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0; color:#FFD700;">Edit Workout Log</h3>
            <input type="hidden" id="edit-workout-id">
            
            <label style="color:#888; font-size:0.8rem;">Date</label>
            <input type="datetime-local" id="edit-date" class="meta-input" style="margin-bottom:10px;">
            
            <label style="color:#888; font-size:0.8rem;">Note</label>
            <input type="text" id="edit-note" class="meta-input" style="margin-bottom:20px;">
            
            <div style="display:flex; gap:10px;">
                <button onclick="saveEditedWorkout()" class="save-btn">Save Changes</button>
                <button onclick="document.getElementById('edit-workout-modal').style.display='none'" class="save-btn" style="background:#333;">Cancel</button>
            </div>
        </div>
    </div>

    <div id="client-modal" class="modal-overlay">
        <div class="modal-box" style="max-width:800px;">
            <span class="close-popup" onclick="document.getElementById('client-modal').style.display='none'" style="float:right; cursor:pointer; font-size:24px;">&times;</span>
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                <img id="modal-client-img" src="images/profile-placeholder.png" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #FFD700;">
                <div>
                    <h2 id="modal-client-name" style="margin: 0; color: white;">Client Name</h2>
                    <p id="modal-client-email" style="color: #888; margin: 5px 0;">email</p>
                </div>
            </div>
            <h3 style="color: #FFD700; border-bottom: 1px solid #333; padding-bottom: 10px;">Weight Progress</h3>
            <div style="height: 300px; width: 100%;">
                <canvas id="coachViewChart"></canvas>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, onSnapshot, orderBy, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-Ozd5hlChO_gjvhHF4P9UIVyGW03msgI",
            authDomain: "trainwise-webapp.firebaseapp.com",
            projectId: "trainwise-webapp",
            storageBucket: "trainwise-webapp.firebasestorage.app",
            messagingSenderId: "644514176585",
            appId: "1:644514176585:web:75dc6a6a11503ce7eb6998",
            measurementId: "G-W09Q3PGNJ7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // STATE
        let clientsList = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let calendarEvents = [];
        let coachChart = null;

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if (!user) window.location.href = "Login.html";
            else {
                const docSnap = await getDoc(doc(db, "users", user.uid));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.role !== 'coach') window.location.href = "index.html"; // Protect dashboard
                    
                    document.getElementById('header-username').innerText = data.name || "Coach";
                    if(data.photoURL) document.getElementById('header-profile-img').src = `images/${data.photoURL}`;
                    
                    loadClientsData(user.uid);
                    loadCoachExercises(user.uid);
                }
            }
        });

        // 1. NAVIGATION
        const navs = {
            dashboard: document.getElementById('nav-dashboard'),
            clients: document.getElementById('nav-clients'),
            calendar: document.getElementById('nav-calendar'),
            messages: document.getElementById('nav-messages'),
            exercises: document.getElementById('nav-exercises'),
            workouts: document.getElementById('nav-workouts')
        };
        const sections = {
            dashboard: document.getElementById('section-overview'),
            clients: document.getElementById('section-clients'),
            calendar: document.getElementById('section-calendar'),
            messages: document.getElementById('section-messages'),
            exercises: document.getElementById('section-exercises'),
            workouts: document.getElementById('section-workouts')
        };

        function switchTab(key) {
            Object.values(navs).forEach(n => n.classList.remove('active'));
            if(navs[key]) navs[key].classList.add('active');
            Object.values(sections).forEach(s => s.style.display = 'none');
            if(sections[key]) sections[key].style.display = 'block';

            if(key === 'messages') loadChatUsers();
        }

        Object.keys(navs).forEach(key => {
            navs[key].addEventListener('click', (e) => { e.preventDefault(); switchTab(key); });
        });

        // 2. CLIENTS DATA & SELECTORS
        async function loadClientsData(coachId) {
            const q = query(collection(db, "users"), where("myCoachId", "==", coachId));
            const snapshot = await getDocs(q);
            clientsList = [];
            const container = document.getElementById('clients-list-container');
            const calSelect = document.getElementById('cal-client-select');
            const workSelect = document.getElementById('workout-client-select');
            
            container.innerHTML = "";
            calSelect.innerHTML = '<option value="">Select Athlete to Plan...</option>';
            workSelect.innerHTML = '<option value="">Select Athlete to view logs...</option>';

            document.getElementById('stat-total-clients').innerText = snapshot.size;

            snapshot.forEach(docSnap => {
                const client = { id: docSnap.id, ...docSnap.data() };
                clientsList.push(client);

                // Populate Clients List
                const card = document.createElement('div');
                card.className = 'client-item';
                card.style.cssText = "display:flex; align-items:center; padding:15px; border-bottom:1px solid #333; gap:15px;";
                card.innerHTML = `
                    <img src="${client.photoURL ? 'images/'+client.photoURL : 'images/avatar-19.png'}" style="width:50px; height:50px; border-radius:50%; object-fit:cover;">
                    <div style="flex:1;">
                        <h4 style="margin:0; color:white;">${client.name}</h4>
                        <span style="color:#666; font-size:0.8rem;">${client.email}</span>
                    </div>
                    <button class="save-btn" onclick="openClientProfile('${client.id}')" style="width:auto; padding:5px 15px;">Profile</button>
                `;
                container.appendChild(card);

                // Populate Dropdowns
                const opt1 = document.createElement('option'); opt1.value = client.id; opt1.innerText = client.name;
                calSelect.appendChild(opt1);
                
                const opt2 = document.createElement('option'); opt2.value = client.id; opt2.innerText = client.name;
                workSelect.appendChild(opt2);
            });

            if(snapshot.empty) container.innerHTML = '<p style="text-align:center; padding:20px; color:#666;">No clients yet.</p>';
        }

        // 3. INVITE LOGIC
        document.getElementById('add-client-btn').onclick = () => document.getElementById('invite-modal').style.display = 'flex';
        document.getElementById('send-invite-btn').onclick = async () => {
            const email = document.getElementById('invite-email').value;
            const status = document.getElementById('invite-status');
            const coach = auth.currentUser;
            
            const q = query(collection(db, "users"), where("email", "==", email));
            const snap = await getDocs(q);
            if(snap.empty) { status.innerText = "User not found."; status.style.color="red"; return; }
            
            const athleteId = snap.docs[0].id;
            await addDoc(collection(db, "invitations"), {
                fromCoachId: coach.uid, fromCoachName: document.getElementById('header-username').innerText,
                toAthleteId: athleteId, status: 'pending', timestamp: serverTimestamp()
            });
            status.innerText = "Sent!"; status.style.color="green";
            setTimeout(()=> document.getElementById('invite-modal').style.display='none', 1500);
        };

        // 4. CALENDAR LOGIC
        document.getElementById('cal-client-select').addEventListener('change', (e) => {
            const uid = e.target.value;
            if(!uid) {
                document.getElementById('calendar-wrapper').style.display='none';
                document.getElementById('cal-placeholder').style.display='block';
                return;
            }
            document.getElementById('calendar-wrapper').style.display='block';
            document.getElementById('cal-placeholder').style.display='none';
            
            const q = query(collection(db, `users/${uid}/calendar`));
            onSnapshot(q, (snap) => {
                calendarEvents = [];
                snap.forEach(d => calendarEvents.push(d.data()));
                renderCalendar();
            });
        });

        window.renderCalendar = function() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = "";
            document.getElementById('calendar-month-year').innerText = new Date(currentYear, currentMonth).toLocaleString('default', {month:'long', year:'numeric'});
            
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth+1, 0);
            const startDayIndex = firstDay.getDay() === 0 ? 6 : firstDay.getDay()-1;

            for(let i=0; i<startDayIndex; i++) grid.appendChild(document.createElement('div'));

            for(let d=1; d<=lastDay.getDate(); d++) {
                const dateStr = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const div = document.createElement('div');
                div.className = 'calendar-day';
                div.innerHTML = `<span class="day-number">${d}</span>`;
                
                calendarEvents.filter(e => e.date === dateStr).forEach(ev => {
                    div.innerHTML += `<div class="event-pill ${ev.byCoach?'':'self'}">${ev.title}</div>`;
                });

                div.onclick = () => {
                    document.getElementById('assign-date').value = dateStr;
                    document.getElementById('assign-title').value = "";
                    document.getElementById('assign-note').value = "";
                    document.getElementById('assign-modal').style.display = 'flex';
                };
                grid.appendChild(div);
            }
        };

        window.saveAssignment = async function() {
            const uid = document.getElementById('cal-client-select').value;
            const date = document.getElementById('assign-date').value;
            const title = document.getElementById('assign-title').value;
            const note = document.getElementById('assign-note').value;
            if(!title || !uid) return;
            await addDoc(collection(db, `users/${uid}/calendar`), { date, title, note, byCoach: true });
            document.getElementById('assign-modal').style.display = 'none';
        };

        window.prevMonth = function() { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(); };
        window.nextMonth = function() { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(); };

        // 5. EXERCISES (Coach Library)
        window.openCreateExModal = () => document.getElementById('create-ex-modal').style.display = 'flex';
        
        async function loadCoachExercises(uid) {
            const grid = document.getElementById('main-library-grid');
            const q = query(collection(db, `users/${uid}/exercises`), orderBy('name'));
            onSnapshot(q, (snap) => {
                grid.innerHTML = "";
                if(snap.empty) { grid.innerHTML = '<p style="text-align:center; grid-column:1/-1; color:#666;">No exercises. Create one!</p>'; return; }
                snap.forEach(docSnap => {
                    const ex = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'lib-card';
                    card.innerHTML = `
                        <div class="lib-icon"><i class="fas fa-dumbbell"></i></div>
                        <div class="lib-title">${ex.name}</div>
                        <div class="lib-cat">${ex.category}</div>
                        <button class="lib-del" onclick="deleteExercise('${docSnap.id}')">&times;</button>
                    `;
                    grid.appendChild(card);
                });
            });
        }

        window.saveNewExercise = async function() {
            const name = document.getElementById('new-ex-name').value;
            const cat = document.getElementById('new-ex-cat').value;
            if(!name) return;
            await addDoc(collection(db, `users/${auth.currentUser.uid}/exercises`), { name, category: cat });
            document.getElementById('create-ex-modal').style.display = 'none';
        };
        window.deleteExercise = async (id) => { if(confirm("Delete exercise?")) await deleteDoc(doc(db, `users/${auth.currentUser.uid}/exercises`, id)); };

        // 6. WORKOUTS (View Client History)
        document.getElementById('workout-client-select').addEventListener('change', async (e) => {
            const uid = e.target.value;
            const container = document.getElementById('client-workouts-list');
            if(!uid) { container.innerHTML = '<p style="text-align:center; color:#666; padding:40px;">Select a client.</p>'; return; }
            
            container.innerHTML = "Loading...";
            const q = query(collection(db, `users/${uid}/workouts`), orderBy('date', 'desc'));
            onSnapshot(q, (snap) => {
                container.innerHTML = "";
                if(snap.empty) { container.innerHTML = '<p style="text-align:center; padding:20px;">No workouts logged.</p>'; return; }
                
                snap.forEach(docSnap => {
                    const w = docSnap.data();
                    const dateStr = new Date(w.date).toLocaleDateString();
                    const div = document.createElement('div');
                    div.className = 'history-card';
                    div.innerHTML = `
                        <div>
                            <div class="hist-date">${dateStr}</div>
                            <div class="hist-stats">${w.duration||0} min | ${w.exercises?.length||0} Exercises</div>
                            <div style="color:#666; font-size:0.8rem; margin-top:5px;">${w.note || ""}</div>
                        </div>
                        <div class="hist-actions">
                            <button onclick="openEditWorkout('${uid}', '${docSnap.id}')"><i class="fas fa-pen"></i></button>
                            <button class="del" onclick="deleteClientWorkout('${uid}', '${docSnap.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    container.appendChild(div);
                });
            });
        });

        // Edit Workout Logic
        let editingWorkoutRef = null; // Store {uid, id}
        window.openEditWorkout = async function(uid, wid) {
            const snap = await getDoc(doc(db, `users/${uid}/workouts`, wid));
            if(snap.exists()) {
                const d = snap.data();
                editingWorkoutRef = { uid, wid };
                document.getElementById('edit-workout-id').value = wid;
                document.getElementById('edit-date').value = d.date;
                document.getElementById('edit-note').value = d.note || "";
                document.getElementById('edit-workout-modal').style.display = 'flex';
            }
        };

        window.saveEditedWorkout = async function() {
            if(!editingWorkoutRef) return;
            const date = document.getElementById('edit-date').value;
            const note = document.getElementById('edit-note').value;
            
            await updateDoc(doc(db, `users/${editingWorkoutRef.uid}/workouts`, editingWorkoutRef.wid), {
                date: date, note: note
            });
            document.getElementById('edit-workout-modal').style.display = 'none';
        };

        window.deleteClientWorkout = async function(uid, wid) {
            if(confirm("Delete this client's workout?")) {
                await deleteDoc(doc(db, `users/${uid}/workouts`, wid));
            }
        };

        // 7. CLIENT PROFILE & CHART (Reuse Logic)
        window.openClientProfile = async function(clientId) {
            const modal = document.getElementById('client-modal');
            modal.style.display = 'flex';
            const userRef = doc(db, "users", clientId);
            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('modal-client-name').innerText = data.name || "Unknown";
                document.getElementById('modal-client-email').innerText = data.email;
                document.getElementById('modal-client-img').src = data.photoURL ? `images/${data.photoURL}` : "images/avatar-19.png";
                
                const history = data.weightHistory || [];
                history.sort((a, b) => new Date(a.date) - new Date(b.date));
                const ctx = document.getElementById('coachViewChart').getContext('2d');
                if (coachChart) coachChart.destroy();
                coachChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map(item => new Date(item.date).toLocaleDateString()),
                        datasets: [{ label: 'Weight', data: history.map(i => i.weight), borderColor: '#FFD700', backgroundColor: 'rgba(255, 215, 0, 0.2)', fill: true }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: '#222' } }, y: { grid: { color: '#222' } } } }
                });
            }
        };

        // 8. CHAT LOGIC 
        let unsubscribeChat = null;
        let currentChatPartnerId = null;
        
        async function loadChatUsers() {
            const list = document.getElementById('chat-users-list');
            list.innerHTML = "";
            clientsList.forEach(client => {
                const div = document.createElement('div');
                div.className = 'chat-user-item'; // Add CSS class if needed in style
                div.style.padding = "10px"; div.style.cursor="pointer"; div.style.borderBottom="1px solid #333";
                div.innerHTML = `<strong>${client.name}</strong>`;
                div.onclick = () => openChat(client.id, client.name);
                list.appendChild(div);
            });
        }

        function openChat(partnerId, name) {
            currentChatPartnerId = partnerId;
            document.getElementById('chat-partner-name').innerText = name;
            document.getElementById('chat-form').style.display = "flex";
            const myId = auth.currentUser.uid;
            const conversationId = myId < partnerId ? `${myId}_${partnerId}` : `${partnerId}_${myId}`;
            
            if (unsubscribeChat) unsubscribeChat();
            const q = query(collection(db, "chats", conversationId, "messages"), orderBy("timestamp", "asc"));
            unsubscribeChat = onSnapshot(q, (snap) => {
                const area = document.getElementById('chat-messages-area');
                area.innerHTML = "";
                snap.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderId === myId;
                    const div = document.createElement('div');
                    div.className = `message-bubble ${isMe?'me':'them'}`;
                    div.innerText = msg.text;
                    area.appendChild(div);
                });
                area.scrollTop = area.scrollHeight;
            });
        }

        document.getElementById('chat-form').addEventListener('submit', async(e) => {
            e.preventDefault();
            const inp = document.getElementById('chat-input');
            const txt = inp.value.trim();
            if(!txt || !currentChatPartnerId) return;
            const myId = auth.currentUser.uid;
            const cid = myId < currentChatPartnerId ? `${myId}_${currentChatPartnerId}` : `${currentChatPartnerId}_${myId}`;
            inp.value = "";
            await addDoc(collection(db, "chats", cid, "messages"), { text: txt, senderId: myId, timestamp: serverTimestamp() });
        });

    </script>
</body>
</html>