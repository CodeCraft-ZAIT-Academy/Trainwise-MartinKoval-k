<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainwise - Coach Dashboard</title>
    <link rel="stylesheet" href="style2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <header class="app-header">
        <a href="index.html" class="app-logo-container">
            <img src="images/logo3.png" alt="TR Logo" class="app-logo">
            <span class="app-title">DASHBOARD</span>
        </a>

        <div class="header-right">
            <span id="header-username" class="user-name"></span>
            <a href="account.html" class="profile-link">
                <img id="header-profile-img" src="images/avatar-20.png" alt="Profile" class="header-avatar">
            </a>
        </div>
    </header>

    <div class="app-container">
        
        <aside class="app-sidebar">
            
            <a href="#" id="nav-dashboard" class="sidebar-btn active">
                <img src="images/dashboard.png" alt="Dashboard" class="sidebar-icon">
                <span>Dashboard</span>
            </a>

            <a href="#" id="nav-clients" class="sidebar-btn">
                <img src="images/clients.png" alt="Clients" class="sidebar-icon">
                <span>Clients</span>
            </a>

            <a href="#" class="sidebar-btn">
                <img src="images/calendar.png" alt="Calendar" class="sidebar-icon">
                <span>Calendar</span>
            </a>

            <a href="#" id="nav-messages" class="sidebar-btn">
                <img src="images/messages.png" alt="Messages" class="sidebar-icon">
                <span>Messages</span>
            </a>

            <a href="#" class="sidebar-btn">
                <img src="images/exercises.png" alt="Exercises" class="sidebar-icon">
                <span>Exercises</span>
            </a>

            <a href="#" class="sidebar-btn">
                <img src="images/workouts.png" alt="Workouts" class="sidebar-icon">
                <span>Workouts</span>
            </a>

            <a href="#" class="sidebar-btn ai-btn">
                <i class="fas fa-robot" style="margin-right: 12px; color: #FFD700;"></i>
                <span>AI Assistant</span>
                <span class="badge-new">NEW</span>
            </a>

        </aside>

        <main class="app-content">
            
            <div id="section-overview">
                <div class="content-header">
                    <h2>Coach Overview</h2>
                    <p class="subtitle">Welcome back, Coach! Here is what's happening today.</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-label">Total Clients</span>
                        <span class="stat-value">24</span>
                        <span class="stat-change positive">+2 this month</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Active Programs</span>
                        <span class="stat-value">18</span>
                        <span class="stat-change">92% completion rate</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-label">Revenue (Dec)</span>
                        <span class="stat-value">1,450‚Ç¨</span>
                        <span class="stat-change positive">+15% vs last month</span>
                    </div>
                </div>

                <div class="dashboard-main-grid">
                    <div class="dash-panel chart-panel">
                        <h3>Weekly Activity</h3>
                        <div class="fake-chart">
                            <div class="bar" style="height: 40%"><span>M</span></div>
                            <div class="bar active" style="height: 90%"><span>T</span></div>
                            <div class="bar" style="height: 60%"><span>F</span></div>
                            <div class="bar" style="height: 30%"><span>S</span></div>
                            <div class="bar" style="height: 20%"><span>S</span></div>
                        </div>
                    </div>
                    <div class="dash-panel clients-panel">
                        <h3>Recent Updates</h3>
                        <div class="client-item">
                            <div class="client-info"><strong>Filip Nagy</strong><span>Logged workout</span></div>
                            <span class="time">2m ago</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="section-clients" style="display: none;">
                <div class="content-header" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h2>My Clients</h2>
                        <p class="subtitle">Manage your athletes and invitations.</p>
                    </div>
                    <button id="add-client-btn" class="save-btn" style="width: auto; padding: 10px 25px;">+ Add Client</button>
                </div>

                <div class="dash-panel" style="min-height: 400px;">
                    <div style="display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px;">
                        <span style="color: #FFD700; border-bottom: 2px solid #FFD700; cursor: pointer;">Active Clients</span>
                        <span style="color: #666; cursor: pointer;">Invites Sent</span>
                    </div>
                    <div id="clients-list-container">
                        <p style="color: #666; text-align: center; margin-top: 50px;">
                            Your active clients will appear here.
                        </p>
                    </div>
                </div>
            </div>

            <div id="section-messages" style="display: none;">
                <div class="content-header">
                    <h2>Messages</h2>
                    <p class="subtitle">Chat with your athletes in real-time.</p>
                </div>

                <div class="chat-layout">
                    <div class="chat-sidebar-list" id="chat-users-list">
                        <p style="padding: 20px; color: #666; font-size: 0.9rem;">Loading athletes...</p>
                    </div>

                    <div class="chat-window">
                        <div class="chat-header-bar">
                            <span id="chat-partner-name">Select an athlete</span>
                            <button id="delete-connection-btn" class="delete-connection-btn" style="display: none;">
                                üóë Remove Athlete
                            </button>
                        </div>

                        <div class="chat-messages-area" id="chat-messages-area">
                            <div style="text-align: center; color: #444; margin-top: 50px;">
                                Select a client from the left to start chatting.
                            </div>
                        </div>

                        <form class="chat-input-area" id="chat-form" style="display: none;">
                            <input type="text" id="chat-input" class="chat-input" placeholder="Type a message..." autocomplete="off">
                            <button type="submit" class="chat-send-btn">‚û§</button>
                        </form>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <div id="invite-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="text-align: left; max-width: 450px;">
            <div class="modal-header">
                <h3>Invite Athlete</h3>
                <span class="close-modal">&times;</span>
            </div>
            
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 20px;">
                Enter the email address of the athlete. They will receive an invitation in their app.
            </p>

            <div class="input-group">
                <label>Athlete's Email</label>
                <input type="email" id="invite-email" placeholder="athlete@example.com">
            </div>

            <button id="send-invite-btn" class="save-btn">Send Invitation</button>
            <p id="invite-status" style="margin-top: 15px; font-size: 0.9rem; min-height: 20px;"></p>
        </div>
    </div>

<div id="client-modal" class="popup-overlay" style="display: none;">
    <div class="popup-content" style="max-width: 800px; width: 90%; background: #000; border: 1px solid #FFD700;">
        <span class="close-popup" onclick="document.getElementById('client-modal').style.display='none'">&times;</span>
        
        <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
            <img id="modal-client-img" src="images/profile-placeholder.png" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #FFD700;">
            <div>
                <h2 id="modal-client-name" style="margin: 0; color: white;">Client Name</h2>
                <p id="modal-client-email" style="color: #888; margin: 5px 0;">email@example.com</p>
            </div>
        </div>

        <h3 style="color: #FFD700; border-bottom: 1px solid #333; padding-bottom: 10px;">Progress Chart</h3>
        
        <div style="height: 300px; width: 100%;">
            <canvas id="coachViewChart"></canvas>
        </div>
    </div>
</div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, serverTimestamp, onSnapshot, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD-Ozd5hlChO_gjvhHF4P9UIVyGW03msgI",
            authDomain: "trainwise-webapp.firebaseapp.com",
            projectId: "trainwise-webapp",
            storageBucket: "trainwise-webapp.firebasestorage.app",
            messagingSenderId: "644514176585",
            appId: "1:644514176585:web:75dc6a6a11503ce7eb6998",
            measurementId: "G-W09Q3PGNJ7"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        //  ELEMENTY UI 
        const headerProfileImg = document.getElementById('header-profile-img');
        const headerUserName = document.getElementById('header-username');
        
        // Navig√°cia a Sekcie
        const navDashboard = document.getElementById('nav-dashboard');
        const navClients = document.getElementById('nav-clients');
        const navMessages = document.getElementById('nav-messages');
        
        const sectionOverview = document.getElementById('section-overview');
        const sectionClients = document.getElementById('section-clients');
        const sectionMessages = document.getElementById('section-messages');

        // Modal Invite
        const inviteModal = document.getElementById('invite-modal');
        const addClientBtn = document.getElementById('add-client-btn');
        const closeModal = document.querySelector('.close-modal');
        const sendInviteBtn = document.getElementById('send-invite-btn');
        const inviteEmailInput = document.getElementById('invite-email');
        const inviteStatus = document.getElementById('invite-status');

        // Modal Client Profile (GRAF)
        const clientModal = document.getElementById('client-modal'); 
        let coachChart = null; // Premenn√° pre graf

        // Chat
        const chatUsersList = document.getElementById('chat-users-list');
        const chatMessagesArea = document.getElementById('chat-messages-area');
        const chatPartnerName = document.getElementById('chat-partner-name');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const deleteConnectionBtn = document.getElementById('delete-connection-btn');

        let currentChatPartnerId = null;
        let unsubscribeChat = null;

        //  1.  TABS 
        function switchTab(activeBtn, showSection) {
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
            if(activeBtn) activeBtn.classList.add('active');

            sectionOverview.style.display = 'none';
            sectionClients.style.display = 'none';
            sectionMessages.style.display = 'none';

            if(showSection) showSection.style.display = 'block';
        }

        if(navDashboard) {
            navDashboard.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab(navDashboard, sectionOverview);
            });
        }

        if(navClients) {
            navClients.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab(navClients, sectionClients);
                loadClientsGrid(); 
            });
        }

        if(navMessages) {
            navMessages.addEventListener('click', (e) => {
                e.preventDefault();
                switchTab(navMessages, sectionMessages);
                loadChatUsers(); 
            });
        }

        //  2. MODAL LOGIKA (INVITE)
        if(addClientBtn) {
            addClientBtn.addEventListener('click', () => { inviteModal.style.display = 'flex'; });
            closeModal.addEventListener('click', () => { inviteModal.style.display = 'none'; });
            window.onclick = (e) => { 
                if (e.target == inviteModal) inviteModal.style.display = "none"; 
                if (e.target == clientModal) clientModal.style.display = "none"; // Zatvorenie aj profilu klikom vedƒæa
            };
        }

        //  3. POSIELANIE POZV√ÅNKY 
        if(sendInviteBtn) {
            sendInviteBtn.addEventListener('click', async () => {
                const email = inviteEmailInput.value.trim();
                if (!email) return;

                inviteStatus.innerText = "Searching user...";
                inviteStatus.style.color = "#FFD700";

                try {
                    const usersRef = collection(db, "users");
                    const q = query(usersRef, where("email", "==", email));
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        inviteStatus.innerText = "User not found. Check email.";
                        inviteStatus.style.color = "#FF4444";
                        return;
                    }

                    let athleteId = null;
                    let athleteName = "Unknown";
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.role === 'athlete') {
                            athleteId = doc.id;
                            athleteName = data.name || "Athlete";
                        }
                    });

                    if (!athleteId) {
                        inviteStatus.innerText = "This user is not an Athlete.";
                        inviteStatus.style.color = "#FF4444";
                        return;
                    }

                    const coach = auth.currentUser;
                    await addDoc(collection(db, "invitations"), {
                        fromCoachId: coach.uid,
                        fromCoachEmail: coach.email,
                        fromCoachName: headerUserName.innerText || "Coach",
                        toAthleteId: athleteId,
                        status: "pending",
                        timestamp: serverTimestamp()
                    });

                    inviteStatus.innerText = `Invite sent to ${athleteName}! ‚úÖ`;
                    inviteStatus.style.color = "#00FF88";
                    
                    setTimeout(() => { 
                        inviteModal.style.display = 'none'; 
                        inviteEmailInput.value = "";
                        inviteStatus.innerText = "";
                    }, 2000);

                } catch (error) {
                    console.error(error);
                    inviteStatus.innerText = "Error sending invite.";
                    inviteStatus.style.color = "#FF4444";
                }
            });
        }

        //  4. CHAT LOGIKA 
        async function loadChatUsers() {
            chatUsersList.innerHTML = "";
            const user = auth.currentUser;
            if (!user) return;

            const q = query(collection(db, "users"), where("myCoachId", "==", user.uid));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                chatUsersList.innerHTML = "<p style='padding:15px'>No athletes connected yet.</p>";
                return;
            }

            snapshot.forEach(docSnap => {
                const athlete = docSnap.data();
                const div = document.createElement('div');
                div.classList.add('chat-user-item');
                
                const imgUrl = athlete.photoURL ? `images/${athlete.photoURL}` : "images/avatar-19.png";
                div.innerHTML = `
                    <img src="${imgUrl}" class="chat-user-avatar">
                    <span>${athlete.name || "Athlete"}</span>
                `;

                div.addEventListener('click', () => {
                    document.querySelectorAll('.chat-user-item').forEach(el => el.classList.remove('active'));
                    div.classList.add('active');
                    openChat(docSnap.id, athlete.name || "Athlete");
                });

                chatUsersList.appendChild(div);
            });
        }

        function openChat(partnerId, partnerName) {
            currentChatPartnerId = partnerId;
            chatPartnerName.innerText = partnerName;
            chatForm.style.display = "flex";
            deleteConnectionBtn.style.display = "block";

            if (unsubscribeChat) unsubscribeChat();

            const myId = auth.currentUser.uid;
            const conversationId = myId < partnerId ? `${myId}_${partnerId}` : `${partnerId}_${myId}`;

            const q = query(collection(db, "chats", conversationId, "messages"), orderBy("timestamp", "asc"));

            unsubscribeChat = onSnapshot(q, (snapshot) => {
                chatMessagesArea.innerHTML = "";
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const isMe = msg.senderId === myId;
                    
                    const bubble = document.createElement('div');
                    bubble.classList.add('message-bubble');
                    bubble.classList.add(isMe ? 'me' : 'them');
                    
                    const date = msg.timestamp ? msg.timestamp.toDate() : new Date();
                    const timeStr = date.getHours() + ":" + (date.getMinutes()<10?'0':'') + date.getMinutes();

                    bubble.innerHTML = `${msg.text}<span class="msg-time">${timeStr}</span>`;
                    chatMessagesArea.appendChild(bubble);
                });
                chatMessagesArea.scrollTop = chatMessagesArea.scrollHeight;
            });
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = chatInput.value.trim();
            if (!text || !currentChatPartnerId) return;

            const myId = auth.currentUser.uid;
            const conversationId = myId < currentChatPartnerId ? `${myId}_${currentChatPartnerId}` : `${currentChatPartnerId}_${myId}`;

            chatInput.value = ""; 

            await addDoc(collection(db, "chats", conversationId, "messages"), {
                text: text,
                senderId: myId,
                timestamp: serverTimestamp()
            });
        });

        deleteConnectionBtn.addEventListener('click', async () => {
            if(!currentChatPartnerId) return;
            if(confirm(`Remove ${chatPartnerName.innerText}? They will be disconnected.`)) {
                try {
                    await updateDoc(doc(db, "users", currentChatPartnerId), { myCoachId: null });
                    alert("Athlete removed.");
                    chatMessagesArea.innerHTML = "";
                    chatPartnerName.innerText = "Select an athlete";
                    chatForm.style.display = "none";
                    deleteConnectionBtn.style.display = "none";
                    loadChatUsers();
                } catch(e) { console.error(e); }
            }
        });

        // - 5. AUTH A LOAD DATA 
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "Login.html";
            } else {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.role !== 'coach') {
                        window.location.href = "index.html";
                        return;
                    }
                    if (data.name) headerUserName.innerText = data.name;
                    if (data.photoURL) headerProfileImg.src = `images/${data.photoURL}`;
                    else headerProfileImg.src = "images/avatar-20.png";
                }
            }
        });

        // === 6. FUNKCIA PRE CLIENTS GRID 
        async function loadClientsGrid() {
            const clientsContainer = document.getElementById('clients-list-container');
            clientsContainer.innerHTML = '<p style="color: #666; text-align: center; margin-top: 20px;">Loading...</p>';
            
            const user = auth.currentUser;
            if (!user) return;

            const q = query(collection(db, "users"), where("myCoachId", "==", user.uid));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                clientsContainer.innerHTML = '<p style="color: #666; text-align: center; margin-top: 50px;">No active clients found. Use "Add Client" to invite someone.</p>';
                return;
            }

            clientsContainer.innerHTML = ""; 

            snapshot.forEach(docSnap => {
                const client = docSnap.data();
                const imgUrl = client.photoURL ? `images/${client.photoURL}` : "images/avatar-19.png";
                
                const card = document.createElement('div');
                card.className = 'client-item'; 
                card.style.display = "flex";
                card.style.alignItems = "center";
                card.style.padding = "15px";
                card.style.borderBottom = "1px solid #333";
                card.style.gap = "15px";

                
                card.innerHTML = `
                    <img src="${imgUrl}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: white;">${client.name || "Athlete"}</h4>
                        <span style="color: #666; font-size: 0.8rem;">${client.email}</span>
                    </div>
                    <button class="save-btn" onclick="openClientProfile('${docSnap.id}')" style="width: auto; padding: 5px 15px; font-size: 0.8rem;">View Profile</button>
                `;

                clientsContainer.appendChild(card);
            });
        }

        // === 7. NOV√Å FUNKCIA: OTVORENIE PROFILU KLIENTA A GRAF ===
        
        window.openClientProfile = async function(clientId) {
            const modal = document.getElementById('client-modal');
            modal.style.display = 'flex'; // Otvori≈• okno

            const userRef = doc(db, "users", clientId);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // 1. Naplni≈• hlaviƒçku (Meno, Foto)
                document.getElementById('modal-client-name').innerText = data.name || "Unknown Athlete";
                document.getElementById('modal-client-email').innerText = data.email;
                if(data.photoURL) document.getElementById('modal-client-img').src = `images/${data.photoURL}`;
                else document.getElementById('modal-client-img').src = "images/avatar-19.png";

                // 2. Vykresli≈• graf (Spracovanie hist√≥rie)
                const history = data.weightHistory || [];
                // Zorad√≠me podƒæa d√°tumu
                history.sort((a, b) => new Date(a.date) - new Date(b.date));

                const labels = history.map(item => new Date(item.date).toLocaleDateString());
                const weights = history.map(item => item.weight);

                const ctx = document.getElementById('coachViewChart').getContext('2d');
                
                // Ak u≈æ graf existuje, mus√≠me ho zniƒçi≈•, inak sa prekryje
                if (coachChart) coachChart.destroy();

                // Vytvorenie grafu
                coachChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Weight',
                            data: weights,
                            borderColor: '#FFD700',
                            backgroundColor: 'rgba(255, 215, 0, 0.2)',
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#000',
                            pointBorderColor: '#FFD700'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: '#111',
                                titleColor: '#FFD700',
                                bodyColor: '#FFF'
                            }
                        },
                        scales: {
                            x: { grid: { color: '#222' }, ticks: { color: '#666' } },
                            y: { grid: { color: '#222' }, ticks: { color: '#666' } }
                        }
                    }
                });
            }
        };

    </script>
</body>
</html>